// SPDX-License-Identifier: GPL-3.0
pragma solidity ^0.8.13;

import "forge-std/Test.sol";
import "forge-std/console.sol";
import "../../src/verifier/Groth16Verifier64Leaves.sol";

contract Groth16Verifier64LeavesTest is Test {
    Groth16Verifier64Leaves public verifier;

    // BLS12-381 proof constants from test/64_leaves/proof.json - split into PART1/PART2
    uint256 constant pA_x_PART1 = 0x0000000000000000000000000000000003df35dcbd78d9a4c341322f90b2cf91;
    uint256 constant pA_x_PART2 = 0xbaa180187635e6550d12490ca0ef43caeff2c8a71838f44b9f093df7cd9368db;
    uint256 constant pA_y_PART1 = 0x00000000000000000000000000000000055d7bc4ab0aa4845e8af31164595c6e;
    uint256 constant pA_y_PART2 = 0x88762163296690f32a0fdd98a0752a53703526d63de243fb4670676efcfb3375;

    //x1
    uint256 constant pB_x0_PART1 = 0x00000000000000000000000000000000064d4ec6f2fb2a064b9442ae9ca2d19c;
    uint256 constant pB_x0_PART2 = 0xbb682dd6d2edd4c666288f706cbc8d5dd1f0e2f98aecc602c14aa2442bcd37f8;
    //x0
    uint256 constant pB_x1_PART1 = 0x0000000000000000000000000000000012d4de8cda327ce2b6bd3c64b09baced;
    uint256 constant pB_x1_PART2 = 0xd35b7ca963be2a9f122c2bd76db621ce954f122b4862b76e156e556f31caf9bb;
    //y1
    uint256 constant pB_y0_PART1 = 0x00000000000000000000000000000000015c069694eef6fca8d3ac428db9bff5;
    uint256 constant pB_y0_PART2 = 0xc30547ba53d71319c845ce3ef6e3d9b4cb905c1ba5c8623478d0f95ae1095477;
    //y0
    uint256 constant pB_y1_PART1 = 0x0000000000000000000000000000000000d6eb315ca0a13e1f8155d585a31e44;
    uint256 constant pB_y1_PART2 = 0x30b9489bb3ae6a38a97738e7a27d904b0177ab8ab14c0ac1d89621dfb433606b;

    uint256 constant pC_x_PART1 = 0x0000000000000000000000000000000008d757e0e7647479e08d963ae4dc5611;
    uint256 constant pC_x_PART2 = 0xf05bf821684b270d8744c5134b9d237f6b1747df22e8bcbd51de7440e9fef8b5;
    uint256 constant pC_y_PART1 = 0x000000000000000000000000000000000dc8d26533755ecec6bfa699942632b7;
    uint256 constant pC_y_PART2 = 0x713c4cb4de326a869c15621a384d04e6eef92fff1794a841177cb8d61438c8d5;

    function setUp() public {
        verifier = new Groth16Verifier64Leaves();
    }

    function testValidProof64() public view {
        // Test data from test/64_leaves/proof.json and public.json
        // This proof is generated for BLS12-381 curve with 64-leaf Merkle tree

        // pi_a - G1 point (x_PART1, x_PART2, y_PART1, y_PART2)
        uint256[4] memory _pA = [pA_x_PART1, pA_x_PART2, pA_y_PART1, pA_y_PART2];

        // pi_b - G2 point (x0_PART1, x0_PART2, x1_PART1, x1_PART2, y0_PART1, y0_PART2, y1_PART1, y1_PART2)
        uint256[8] memory _pB =
            [pB_x0_PART1, pB_x0_PART2, pB_x1_PART1, pB_x1_PART2, pB_y0_PART1, pB_y0_PART2, pB_y1_PART1, pB_y1_PART2];

        // pi_c - G1 point (x_PART1, x_PART2, y_PART1, y_PART2)
        uint256[4] memory _pC = [pC_x_PART1, pC_x_PART2, pC_y_PART1, pC_y_PART2];

        // Public signals from public.json (129 values for 64-leaf Merkle tree proof)
        uint256[129] memory _pubSignals = [
            uint256(7193432041252408925865784406584056496181147192681315926945421575186487985114),
            uint256(123456789012345678901234567890),
            uint256(987654321098765432109876543210),
            uint256(111111111111111111111111111111),
            uint256(222222222222222222222222222222),
            uint256(333333333333333333333333333333),
            uint256(444444444444444444444444444444),
            uint256(555555555555555555555555555555),
            uint256(666666666666666666666666666666),
            uint256(777777777777777777777777777777),
            uint256(888888888888888888888888888888),
            uint256(999999999999999999999999999999),
            uint256(101010101010101010101010101010),
            uint256(121212121212121212121212121212),
            uint256(131313131313131313131313131313),
            uint256(141414141414141414141414141414),
            uint256(151515151515151515151515151515),
            uint256(161616161616161616161616161616),
            uint256(171717171717171717171717171717),
            uint256(181818181818181818181818181818),
            uint256(191919191919191919191919191919),
            uint256(202020202020202020202020202020),
            uint256(212121212121212121212121212121),
            uint256(232323232323232323232323232323),
            uint256(242424242424242424242424242424),
            uint256(252525252525252525252525252525),
            uint256(262626262626262626262626262626),
            uint256(272727272727272727272727272727),
            uint256(282828282828282828282828282828),
            uint256(292929292929292929292929292929),
            uint256(303030303030303030303030303030),
            uint256(313131313131313131313131313131),
            uint256(323232323232323232323232323232),
            uint256(343434343434343434343434343434),
            uint256(353535353535353535353535353535),
            uint256(363636363636363636363636363636),
            uint256(373737373737373737373737373737),
            uint256(383838383838383838383838383838),
            uint256(393939393939393939393939393939),
            uint256(404040404040404040404040404040),
            uint256(414141414141414141414141414141),
            uint256(424242424242424242424242424242),
            uint256(434343434343434343434343434343),
            uint256(454545454545454545454545454545),
            uint256(464646464646464646464646464646),
            uint256(474747474747474747474747474747),
            uint256(484848484848484848484848484848),
            uint256(494949494949494949494949494949),
            uint256(505050505050505050505050505050),
            uint256(515151515151515151515151515151),
            uint256(525252525252525252525252525252),
            uint256(535353535353535353535353535353),
            uint256(545454545454545454545454545454),
            uint256(565656565656565656565656565656),
            uint256(575757575757575757575757575757),
            uint256(585858585858585858585858585858),
            uint256(595959595959595959595959595959),
            uint256(606060606060606060606060606060),
            uint256(616161616161616161616161616161),
            uint256(626262626262626262626262626262),
            uint256(636363636363636363636363636363),
            uint256(646464646464646464646464646464),
            uint256(656565656565656565656565656565),
            uint256(666666666666666666666666666666),
            uint256(676767676767676767676767676767),
            uint256(1000000000000000000000000000000),
            uint256(2000000000000000000000000000000),
            uint256(3000000000000000000000000000000),
            uint256(4000000000000000000000000000000),
            uint256(5000000000000000000000000000000),
            uint256(6000000000000000000000000000000),
            uint256(7000000000000000000000000000000),
            uint256(8000000000000000000000000000000),
            uint256(9000000000000000000000000000000),
            uint256(1100000000000000000000000000000),
            uint256(1200000000000000000000000000000),
            uint256(1300000000000000000000000000000),
            uint256(1400000000000000000000000000000),
            uint256(1500000000000000000000000000000),
            uint256(1600000000000000000000000000000),
            uint256(1700000000000000000000000000000),
            uint256(1800000000000000000000000000000),
            uint256(1900000000000000000000000000000),
            uint256(2100000000000000000000000000000),
            uint256(2200000000000000000000000000000),
            uint256(2300000000000000000000000000000),
            uint256(2400000000000000000000000000000),
            uint256(2500000000000000000000000000000),
            uint256(2600000000000000000000000000000),
            uint256(2700000000000000000000000000000),
            uint256(2800000000000000000000000000000),
            uint256(2900000000000000000000000000000),
            uint256(3100000000000000000000000000000),
            uint256(3200000000000000000000000000000),
            uint256(3300000000000000000000000000000),
            uint256(3400000000000000000000000000000),
            uint256(3500000000000000000000000000000),
            uint256(3600000000000000000000000000000),
            uint256(3700000000000000000000000000000),
            uint256(3800000000000000000000000000000),
            uint256(3900000000000000000000000000000),
            uint256(4100000000000000000000000000000),
            uint256(4200000000000000000000000000000),
            uint256(4300000000000000000000000000000),
            uint256(4400000000000000000000000000000),
            uint256(4500000000000000000000000000000),
            uint256(4600000000000000000000000000000),
            uint256(4700000000000000000000000000000),
            uint256(4800000000000000000000000000000),
            uint256(4900000000000000000000000000000),
            uint256(5100000000000000000000000000000),
            uint256(5200000000000000000000000000000),
            uint256(5300000000000000000000000000000),
            uint256(5400000000000000000000000000000),
            uint256(5500000000000000000000000000000),
            uint256(5600000000000000000000000000000),
            uint256(5700000000000000000000000000000),
            uint256(5800000000000000000000000000000),
            uint256(5900000000000000000000000000000),
            uint256(6100000000000000000000000000000),
            uint256(6200000000000000000000000000000),
            uint256(6300000000000000000000000000000),
            uint256(6400000000000000000000000000000),
            uint256(6500000000000000000000000000000),
            uint256(6600000000000000000000000000000),
            uint256(6700000000000000000000000000000),
            uint256(6800000000000000000000000000000),
            uint256(6900000000000000000000000000000),
            uint256(7100000000000000000000000000000)
        ];

        // Verify the proof
        bool result = verifier.verifyProof(_pA, _pB, _pC, _pubSignals);
        assertTrue(result, "Valid proof should pass verification");
    }

    function testGasConsumption64() public view {
        // Test data from test/64_leaves/proof.json and public.json
        // This test measures gas consumption for BLS12-381 Groth16 verification

        // pi_a - G1 point (x_PART1, x_PART2, y_PART1, y_PART2)
        uint256[4] memory _pA = [pA_x_PART1, pA_x_PART2, pA_y_PART1, pA_y_PART2];

        // pi_b - G2 point (x0_PART1, x0_PART2, x1_PART1, x1_PART2, y0_PART1, y0_PART2, y1_PART1, y1_PART2)
        uint256[8] memory _pB =
            [pB_x0_PART1, pB_x0_PART2, pB_x1_PART1, pB_x1_PART2, pB_y0_PART1, pB_y0_PART2, pB_y1_PART1, pB_y1_PART2];

        // pi_c - G1 point (x_PART1, x_PART2, y_PART1, y_PART2)
        uint256[4] memory _pC = [pC_x_PART1, pC_x_PART2, pC_y_PART1, pC_y_PART2];

        // Public signals from public.json (129 values for 64-leaf Merkle tree proof)
        uint256[129] memory _pubSignals = [
            uint256(7193432041252408925865784406584056496181147192681315926945421575186487985114),
            uint256(123456789012345678901234567890),
            uint256(987654321098765432109876543210),
            uint256(111111111111111111111111111111),
            uint256(222222222222222222222222222222),
            uint256(333333333333333333333333333333),
            uint256(444444444444444444444444444444),
            uint256(555555555555555555555555555555),
            uint256(666666666666666666666666666666),
            uint256(777777777777777777777777777777),
            uint256(888888888888888888888888888888),
            uint256(999999999999999999999999999999),
            uint256(101010101010101010101010101010),
            uint256(121212121212121212121212121212),
            uint256(131313131313131313131313131313),
            uint256(141414141414141414141414141414),
            uint256(151515151515151515151515151515),
            uint256(161616161616161616161616161616),
            uint256(171717171717171717171717171717),
            uint256(181818181818181818181818181818),
            uint256(191919191919191919191919191919),
            uint256(202020202020202020202020202020),
            uint256(212121212121212121212121212121),
            uint256(232323232323232323232323232323),
            uint256(242424242424242424242424242424),
            uint256(252525252525252525252525252525),
            uint256(262626262626262626262626262626),
            uint256(272727272727272727272727272727),
            uint256(282828282828282828282828282828),
            uint256(292929292929292929292929292929),
            uint256(303030303030303030303030303030),
            uint256(313131313131313131313131313131),
            uint256(323232323232323232323232323232),
            uint256(343434343434343434343434343434),
            uint256(353535353535353535353535353535),
            uint256(363636363636363636363636363636),
            uint256(373737373737373737373737373737),
            uint256(383838383838383838383838383838),
            uint256(393939393939393939393939393939),
            uint256(404040404040404040404040404040),
            uint256(414141414141414141414141414141),
            uint256(424242424242424242424242424242),
            uint256(434343434343434343434343434343),
            uint256(454545454545454545454545454545),
            uint256(464646464646464646464646464646),
            uint256(474747474747474747474747474747),
            uint256(484848484848484848484848484848),
            uint256(494949494949494949494949494949),
            uint256(505050505050505050505050505050),
            uint256(515151515151515151515151515151),
            uint256(525252525252525252525252525252),
            uint256(535353535353535353535353535353),
            uint256(545454545454545454545454545454),
            uint256(565656565656565656565656565656),
            uint256(575757575757575757575757575757),
            uint256(585858585858585858585858585858),
            uint256(595959595959595959595959595959),
            uint256(606060606060606060606060606060),
            uint256(616161616161616161616161616161),
            uint256(626262626262626262626262626262),
            uint256(636363636363636363636363636363),
            uint256(646464646464646464646464646464),
            uint256(656565656565656565656565656565),
            uint256(666666666666666666666666666666),
            uint256(676767676767676767676767676767),
            uint256(1000000000000000000000000000000),
            uint256(2000000000000000000000000000000),
            uint256(3000000000000000000000000000000),
            uint256(4000000000000000000000000000000),
            uint256(5000000000000000000000000000000),
            uint256(6000000000000000000000000000000),
            uint256(7000000000000000000000000000000),
            uint256(8000000000000000000000000000000),
            uint256(9000000000000000000000000000000),
            uint256(1100000000000000000000000000000),
            uint256(1200000000000000000000000000000),
            uint256(1300000000000000000000000000000),
            uint256(1400000000000000000000000000000),
            uint256(1500000000000000000000000000000),
            uint256(1600000000000000000000000000000),
            uint256(1700000000000000000000000000000),
            uint256(1800000000000000000000000000000),
            uint256(1900000000000000000000000000000),
            uint256(2100000000000000000000000000000),
            uint256(2200000000000000000000000000000),
            uint256(2300000000000000000000000000000),
            uint256(2400000000000000000000000000000),
            uint256(2500000000000000000000000000000),
            uint256(2600000000000000000000000000000),
            uint256(2700000000000000000000000000000),
            uint256(2800000000000000000000000000000),
            uint256(2900000000000000000000000000000),
            uint256(3100000000000000000000000000000),
            uint256(3200000000000000000000000000000),
            uint256(3300000000000000000000000000000),
            uint256(3400000000000000000000000000000),
            uint256(3500000000000000000000000000000),
            uint256(3600000000000000000000000000000),
            uint256(3700000000000000000000000000000),
            uint256(3800000000000000000000000000000),
            uint256(3900000000000000000000000000000),
            uint256(4100000000000000000000000000000),
            uint256(4200000000000000000000000000000),
            uint256(4300000000000000000000000000000),
            uint256(4400000000000000000000000000000),
            uint256(4500000000000000000000000000000),
            uint256(4600000000000000000000000000000),
            uint256(4700000000000000000000000000000),
            uint256(4800000000000000000000000000000),
            uint256(4900000000000000000000000000000),
            uint256(5100000000000000000000000000000),
            uint256(5200000000000000000000000000000),
            uint256(5300000000000000000000000000000),
            uint256(5400000000000000000000000000000),
            uint256(5500000000000000000000000000000),
            uint256(5600000000000000000000000000000),
            uint256(5700000000000000000000000000000),
            uint256(5800000000000000000000000000000),
            uint256(5900000000000000000000000000000),
            uint256(6100000000000000000000000000000),
            uint256(6200000000000000000000000000000),
            uint256(6300000000000000000000000000000),
            uint256(6400000000000000000000000000000),
            uint256(6500000000000000000000000000000),
            uint256(6600000000000000000000000000000),
            uint256(6700000000000000000000000000000),
            uint256(6800000000000000000000000000000),
            uint256(6900000000000000000000000000000),
            uint256(7100000000000000000000000000000)
        ];

        // Measure gas consumption
        uint256 gasStart = gasleft();
        bool result = verifier.verifyProof(_pA, _pB, _pC, _pubSignals);
        uint256 gasEnd = gasleft();

        uint256 gasUsed = gasStart - gasEnd;

        // Log the gas consumption
        console.log("=== BLS12-381 Groth16 Verification Gas Report ===");
        console.log("Gas used for proof verification:", gasUsed);
        console.log("Proof verification result:", result ? "PASSED" : "FAILED");
        console.log("Circuit: 64-leaf Merkle tree");
        console.log("Public signals: 129");
        console.log("Curve: BLS12-381");
        console.log("Protocol: Groth16");

        // Assert the proof is valid
        assertTrue(result, "Valid proof should pass verification");
    }
}
