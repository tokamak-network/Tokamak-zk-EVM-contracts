// SPDX-License-Identifier: GPL-3.0
pragma solidity ^0.8.13;

import "forge-std/Test.sol";
import "forge-std/console.sol";
import "../../../src/verifier/Groth16Verifier32Leaves.sol";

contract Groth16Verifier32LeavesTest is Test {
    Groth16Verifier32Leaves public verifier;

    // BLS12-381 proof constants from test/32_leaves/proof.json - split into PART1/PART2
    uint256 constant pA_x_PART1 = 0x00000000000000000000000000000000131e00eb6ba9a3b9fd61acdc9e909bcd;
    uint256 constant pA_x_PART2 = 0xc60795eb6d59149d688f21b2b9f3be63034b057564a3f80e17342caaecaa638e;
    uint256 constant pA_y_PART1 = 0x0000000000000000000000000000000004367b464c9d582ec6b7cd8abb043363;
    uint256 constant pA_y_PART2 = 0xc0f1b06b3b566865c1856588ebd94afd368759dbbd5b64f4d37371b0d495e320;

    //x1
    uint256 constant pB_x0_PART1 = 0x0000000000000000000000000000000010d7d41b359798150e7a63288de8b3f0;
    uint256 constant pB_x0_PART2 = 0xd3938e8d082993af469d2a37402e420ecfaf6d79aa1002ce45f8bb9b2c1582f9;
    //x0
    uint256 constant pB_x1_PART1 = 0x000000000000000000000000000000000c531036c339254e6b5864adbd3611e0;
    uint256 constant pB_x1_PART2 = 0x205a6380cd72fc618c91b86f69c52aaec4ebfe617e54f0c041b7356f3241e21c;

    //y0
    uint256 constant pB_y0_PART1 = 0x0000000000000000000000000000000003b0e7dca5b9a72192b5be190e7bfef9;
    uint256 constant pB_y0_PART2 = 0xc14311e988e898a61c766bfbb246272397770b7972dfee249b52ec4df74cb4c2;
    //y1
    uint256 constant pB_y1_PART1 = 0x00000000000000000000000000000000194cdf0b52d54d5b922950e2e1810b2c;
    uint256 constant pB_y1_PART2 = 0x7a15c5c06cc31adb37d34090f762ff7d925c0657b97d633945136dfe97bf4af7;

    uint256 constant pC_x_PART1 = 0x0000000000000000000000000000000004b3b2102a988de4a19aba67c15bad17;
    uint256 constant pC_x_PART2 = 0xdc415b7719d7c359b51a1f00c9fa19cfcd5baf26d6778131623772d790bd468a;
    uint256 constant pC_y_PART1 = 0x000000000000000000000000000000000ca6b8775b49dd6390acfe96969c8650;
    uint256 constant pC_y_PART2 = 0x39caa56372d4d490065d20c7f160d44fcadd8effb56aeaeb3d1973dc99a10d8b;

    function setUp() public {
        verifier = new Groth16Verifier32Leaves();
    }

    function testValidProof32() public view {
        // Test data from test/proof.json and ../prover/16_leaves/public.json
        // This proof is generated for BLS12-381 curve with 16-leaf Merkle tree

        // pi_a - G1 point (x_PART1, x_PART2, y_PART1, y_PART2)
        uint256[4] memory _pA = [pA_x_PART1, pA_x_PART2, pA_y_PART1, pA_y_PART2];

        // pi_b - G2 point (x0_PART1, x0_PART2, x1_PART1, x1_PART2, y0_PART1, y0_PART2, y1_PART1, y1_PART2)
        uint256[8] memory _pB =
            [pB_x0_PART1, pB_x0_PART2, pB_x1_PART1, pB_x1_PART2, pB_y0_PART1, pB_y0_PART2, pB_y1_PART1, pB_y1_PART2];

        // pi_c - G1 point (x_PART1, x_PART2, y_PART1, y_PART2)
        uint256[4] memory _pC = [pC_x_PART1, pC_x_PART2, pC_y_PART1, pC_y_PART2];

        // Public signals from test/32_leaves/public.json (65 values for 32-leaf Merkle tree proof)
        uint256[65] memory _pubSignals = [
            uint256(5895493230319637670729027073304946012562138136683578821957235132381685112735),
            uint256(6218676549690402052910318315276979534381485872621884367715834658603456243904),
            uint256(2186765496904020529103183152769795343814858726218843677158346586034562439040),
            uint256(2186765496904020529103183152769795343814858726218843677158346586034562439040),
            uint256(5708510646087729135889959965248975632956651064800454628727069218571497917126),
            uint256(2186765496904020529103183152769795343814858726218843677158346586034562439040),
            uint256(2186765496904020529103183152769795343814858726218843677158346586034562439040),
            uint256(2186765496904020529103183152769795343814858726218843677158346586034562439040),
            uint256(2186765496904020529103183152769795343814858726218843677158346586034562439040),
            uint256(2186765496904020529103183152769795343814858726218843677158346586034562439040),
            uint256(2186765496904020529103183152769795343814858726218843677158346586034562439040),
            uint256(2186765496904020529103183152769795343814858726218843677158346586034562439040),
            uint256(2186765496904020529103183152769795343814858726218843677158346586034562439040),
            uint256(2186765496904020529103183152769795343814858726218843677158346586034562439040),
            uint256(2186765496904020529103183152769795343814858726218843677158346586034562439040),
            uint256(2186765496904020529103183152769795343814858726218843677158346586034562439040),
            uint256(2186765496904020529103183152769795343814858726218843677158346586034562439040),
            uint256(2186765496904020529103183152769795343814858726218843677158346586034562439040),
            uint256(2186765496904020529103183152769795343814858726218843677158346586034562439040),
            uint256(2186765496904020529103183152769795343814858726218843677158346586034562439040),
            uint256(2186765496904020529103183152769795343814858726218843677158346586034562439040),
            uint256(2186765496904020529103183152769795343814858726218843677158346586034562439040),
            uint256(2186765496904020529103183152769795343814858726218843677158346586034562439040),
            uint256(2186765496904020529103183152769795343814858726218843677158346586034562439040),
            uint256(2186765496904020529103183152769795343814858726218843677158346586034562439040),
            uint256(2186765496904020529103183152769795343814858726218843677158346586034562439040),
            uint256(2186765496904020529103183152769795343814858726218843677158346586034562439040),
            uint256(2186765496904020529103183152769795343814858726218843677158346586034562439040),
            uint256(2186765496904020529103183152769795343814858726218843677158346586034562439040),
            uint256(2186765496904020529103183152769795343814858726218843677158346586034562439040),
            uint256(2186765496904020529103183152769795343814858726218843677158346586034562439040),
            uint256(2186765496904020529103183152769795343814858726218843677158346586034562439040),
            uint256(2186765496904020529103183152769795343814858726218843677158346586034562439040),
            uint256(2000000000000000000000000000),
            uint256(20000000000000000000000000000),
            uint256(20000000000000000000000000000),
            uint256(1000000),
            uint256(10000000),
            uint256(10000000),
            uint256(10000000),
            uint256(10000000),
            uint256(10000000),
            uint256(10000000),
            uint256(10000000),
            uint256(200000000000000000000000000000),
            uint256(200000000000000000000000000000),
            uint256(200000000000000000000000000000),
            uint256(200000000000000000000000000000),
            uint256(200000000000000000000000000000),
            uint256(100000000),
            uint256(100000000),
            uint256(100000000),
            uint256(100000000),
            uint256(100000000),
            uint256(100000000),
            uint256(100000000),
            uint256(2000000000000000000000000000000),
            uint256(2000000000000000000000000000000),
            uint256(2000000000000000000000000000000),
            uint256(2000000000000000000000000000000),
            uint256(2000000000000000000000000000000),
            uint256(2000000000000000000000000000000),
            uint256(2000000000000000000000000000000),
            uint256(2000000000000000000000000000000),
            uint256(2000000000000000000000000000000)
        ];

        // Verify the proof
        bool result = verifier.verifyProof(_pA, _pB, _pC, _pubSignals);
        assertTrue(result, "Valid proof should pass verification");
    }

    function testGasConsumption32() public view {
        // Test data from test/32_leaves/proof.json and test/32_leaves/public.json
        // This test measures gas consumption for BLS12-381 Groth16 verification

        // pi_a - G1 point (x_PART1, x_PART2, y_PART1, y_PART2)
        uint256[4] memory _pA = [pA_x_PART1, pA_x_PART2, pA_y_PART1, pA_y_PART2];

        // pi_b - G2 point (x0_PART1, x0_PART2, x1_PART1, x1_PART2, y0_PART1, y0_PART2, y1_PART1, y1_PART2)
        uint256[8] memory _pB =
            [pB_x0_PART1, pB_x0_PART2, pB_x1_PART1, pB_x1_PART2, pB_y0_PART1, pB_y0_PART2, pB_y1_PART1, pB_y1_PART2];

        // pi_c - G1 point (x_PART1, x_PART2, y_PART1, y_PART2)
        uint256[4] memory _pC = [pC_x_PART1, pC_x_PART2, pC_y_PART1, pC_y_PART2];

        // Public signals from test/32_leaves/public.json (65 values for 32-leaf Merkle tree proof)
        uint256[65] memory _pubSignals = [
            uint256(5895493230319637670729027073304946012562138136683578821957235132381685112735),
            uint256(6218676549690402052910318315276979534381485872621884367715834658603456243904),
            uint256(2186765496904020529103183152769795343814858726218843677158346586034562439040),
            uint256(2186765496904020529103183152769795343814858726218843677158346586034562439040),
            uint256(5708510646087729135889959965248975632956651064800454628727069218571497917126),
            uint256(2186765496904020529103183152769795343814858726218843677158346586034562439040),
            uint256(2186765496904020529103183152769795343814858726218843677158346586034562439040),
            uint256(2186765496904020529103183152769795343814858726218843677158346586034562439040),
            uint256(2186765496904020529103183152769795343814858726218843677158346586034562439040),
            uint256(2186765496904020529103183152769795343814858726218843677158346586034562439040),
            uint256(2186765496904020529103183152769795343814858726218843677158346586034562439040),
            uint256(2186765496904020529103183152769795343814858726218843677158346586034562439040),
            uint256(2186765496904020529103183152769795343814858726218843677158346586034562439040),
            uint256(2186765496904020529103183152769795343814858726218843677158346586034562439040),
            uint256(2186765496904020529103183152769795343814858726218843677158346586034562439040),
            uint256(2186765496904020529103183152769795343814858726218843677158346586034562439040),
            uint256(2186765496904020529103183152769795343814858726218843677158346586034562439040),
            uint256(2186765496904020529103183152769795343814858726218843677158346586034562439040),
            uint256(2186765496904020529103183152769795343814858726218843677158346586034562439040),
            uint256(2186765496904020529103183152769795343814858726218843677158346586034562439040),
            uint256(2186765496904020529103183152769795343814858726218843677158346586034562439040),
            uint256(2186765496904020529103183152769795343814858726218843677158346586034562439040),
            uint256(2186765496904020529103183152769795343814858726218843677158346586034562439040),
            uint256(2186765496904020529103183152769795343814858726218843677158346586034562439040),
            uint256(2186765496904020529103183152769795343814858726218843677158346586034562439040),
            uint256(2186765496904020529103183152769795343814858726218843677158346586034562439040),
            uint256(2186765496904020529103183152769795343814858726218843677158346586034562439040),
            uint256(2186765496904020529103183152769795343814858726218843677158346586034562439040),
            uint256(2186765496904020529103183152769795343814858726218843677158346586034562439040),
            uint256(2186765496904020529103183152769795343814858726218843677158346586034562439040),
            uint256(2186765496904020529103183152769795343814858726218843677158346586034562439040),
            uint256(2186765496904020529103183152769795343814858726218843677158346586034562439040),
            uint256(2186765496904020529103183152769795343814858726218843677158346586034562439040),
            uint256(2000000000000000000000000000),
            uint256(20000000000000000000000000000),
            uint256(20000000000000000000000000000),
            uint256(1000000),
            uint256(10000000),
            uint256(10000000),
            uint256(10000000),
            uint256(10000000),
            uint256(10000000),
            uint256(10000000),
            uint256(10000000),
            uint256(200000000000000000000000000000),
            uint256(200000000000000000000000000000),
            uint256(200000000000000000000000000000),
            uint256(200000000000000000000000000000),
            uint256(200000000000000000000000000000),
            uint256(100000000),
            uint256(100000000),
            uint256(100000000),
            uint256(100000000),
            uint256(100000000),
            uint256(100000000),
            uint256(100000000),
            uint256(2000000000000000000000000000000),
            uint256(2000000000000000000000000000000),
            uint256(2000000000000000000000000000000),
            uint256(2000000000000000000000000000000),
            uint256(2000000000000000000000000000000),
            uint256(2000000000000000000000000000000),
            uint256(2000000000000000000000000000000),
            uint256(2000000000000000000000000000000),
            uint256(2000000000000000000000000000000)
        ];

        // Measure gas consumption
        uint256 gasStart = gasleft();
        bool result = verifier.verifyProof(_pA, _pB, _pC, _pubSignals);
        uint256 gasEnd = gasleft();

        uint256 gasUsed = gasStart - gasEnd;

        // Log the gas consumption
        console.log("=== BLS12-381 Groth16 Verification Gas Report ===");
        console.log("Gas used for proof verification:", gasUsed);
        console.log("Proof verification result:", result ? "PASSED" : "FAILED");
        console.log("Circuit: 32-leaf Merkle tree");
        console.log("Public signals: 65");
        console.log("Curve: BLS12-381");
        console.log("Protocol: Groth16");

        // Assert the proof is valid
        assertTrue(result, "Valid proof should pass verification");
    }
}
